<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Helix | Illinois</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.0.1">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
  <!-- Google API Libraries -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-logo">
        <img src="{{ url_for('static', filename='images/Illinois_Block_I.png') }}" alt="Illinois Block I" class="logo-img">
        <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Project Helix Logo" class="logo-img">
        <h1>Project Helix @ Illinois</h1>
      </div>
      <div class="header-buttons">
      <!-- Connection Status and Button -->
        <button id="connect-calendar-btn" class="connect-btn">
          ğŸ”— Connect Your Google Calendar
        </button>
        <span id="connection-status" style="display: none;">
          âœ… Connected as <span id="user-email"></span>
          <button id="disconnect-btn" class="disconnect-btn">Disconnect</button>
        </span>
        <!-- Dark Mode Toggle in Header -->
        <button id="dark-mode-toggle-header" class="dark-mode-btn-header" title="Toggle dark mode">ğŸŒ™</button>
      </div>
    </header>

    <!-- Calendar Section -->
    <section class="calendar-section">
      <div class="calendar-grid-container">
        <!-- Your Calendar -->
        <div class="calendar-container">
          <div class="section-header">
            <h2>Your Calendar</h2>
            <div class="calendar-actions">
              <button id="refresh-calendar-btn" class="refresh-btn">ğŸ”„ Refresh</button>
              {% if email_parsing_enabled %}
              <button id="add-email">ğŸ“§ Add from Email</button>
              {% endif %}
              <button id="add-event">+ Add Event</button>
            </div>
          </div>
          <div class="google-calendar-wrapper" id="calendar-wrapper">
            <!-- Calendar Overlay (shown when not connected) -->
            <div id="calendar-overlay" class="calendar-overlay">
              <div class="overlay-content">
                <h3>First, Connect Your Google Calendar</h3>
                <p>Sync your Google Calendar in the top right to view and manage your events</p>
              </div>
            </div>

            <!-- Default placeholder calendar -->
            <iframe
              id="calendar-iframe"
              src="https://calendar.google.com/calendar/embed?src=en.usa%23holiday%40group.v.calendar.google.com&ctz=America/Chicago&mode=MONTH&showTitle=0&showNav=1&showDate=1&showPrint=0&showTabs=0&showCalendars=0"
              style="border: 0"
              width="100%"
              height="600"
              frameborder="0"
              scrolling="no">
            </iframe>
          </div>
        </div>

        <!-- Upcoming Events -->
        <div class="events-panel">
          <h3>Upcoming Events</h3>
          <div id="events-list" style="height: 100%; display: flex; flex-direction: column;">
            <!-- Today's Agenda Calendar Iframe -->
            <iframe
              id="today-agenda-iframe"
              src="https://calendar.google.com/calendar/embed?mode=AGENDA&showTitle=0&showNav=0&showDate=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&height=600&wkst=1&ctz=America/Chicago&src=en.usa%23holiday%40group.v.calendar.google.com"
              style="border: 0; width: 100%; flex: 1; min-height: 550px;"
              frameborder="0"
              scrolling="yes">
            </iframe>
          </div>
        </div>
      </div>
    </section>
    
    <div class="events-sections-wrapper">
      <!-- Browse Events Section -->
      <section class="browse-section">
        <div class="browse-header">
          <h3>Browse Events Near UIUC</h3>
          <div class="search-filter">
            <input type="text" id="search-events" placeholder="Search events..." />
            <select id="filter-category">
              <option value="all">All Categories</option>
            </select>
            <button id="export-ical-btn" class="export-btn" title="Export to iCal format">ğŸ“… iCal</button>
            <button id="export-csv-btn" class="export-btn" title="Export to CSV spreadsheet">ğŸ“Š CSV</button>
            <button id="dark-mode-toggle" class="dark-mode-btn" title="Toggle dark mode">ğŸŒ™</button>
          </div>
        </div>
        <div id="browse-events" class="browse-container">
          <!-- Events will be dynamically loaded here -->
        </div>
      </section>

      <!-- Email Events Section -->
      <section class="email-events-section" id="email-events-section" style="display: none;">
        <div class="browse-header">
          <h3>Email Events</h3>
          <button id="clear-email-events" class="clear-btn">âœ• Clear</button>
        </div>
        <div id="email-events" class="browse-container">
          <!-- Email events will be displayed here -->
        </div>
      </section>
    </div>

    <!-- Event Detail Modal -->
    <div id="detail-modal" class="modal">
      <div class="modal-content detail-modal-content">
        <span class="close-modal" id="close-detail">&times;</span>
        <h2 id="detail-title"></h2>
        <div class="detail-info">
          <div class="detail-row">
            <span class="detail-label">ğŸ“… Date:</span>
            <span id="detail-date"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ğŸ• Time:</span>
            <span id="detail-time"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ğŸ“ Location:</span>
            <span id="detail-location"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ğŸ·ï¸ Category:</span>
            <span id="detail-tag" class="event-tag"></span>
          </div>
          <div class="detail-row description">
            <span class="detail-label">ğŸ“ Description:</span>
            <p id="detail-description"></p>
          </div>
          <a id="detail-link" href="#" target="_blank" class="event-link">View Event Page â†’</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="event-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="close-add-event">&times;</span>
      <h3>Add New Event</h3>
      <input type="text" id="event-title" placeholder="Event Title" required />
      <input type="datetime-local" id="event-date" required />
      <input type="text" id="event-location" placeholder="Location (optional)" />
      <textarea id="event-description" placeholder="Description (optional)" rows="3"></textarea>
      <div class="modal-buttons">
        <button id="save-event" class="btn-primary">Save to Google Calendar</button>
        <button id="close-modal" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Email Parser Modal -->
  <div id="email-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="close-email-modal">&times;</span>
      <h3>Add Events from Email</h3>
      <p style="color: #666; margin-bottom: 20px;">
        This will scan your recent Outlook emails for calendar events and add them to your Google Calendar.
      </p>
      <label for="email-amount">Number of emails to scan (1-25):</label>
      <input type="number" id="email-amount" min="1" max="25" value="5" style="width: 100%; margin-bottom: 20px;" />
      <div class="modal-buttons">
        <button id="process-emails-btn" class="btn-primary">Process Emails</button>
        <button id="close-email-modal-btn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Configuration Script - Fetch from Backend or Fallback -->
  <script>
    // Fallback credentials for GitHub Pages (static hosting)
    // Replace with your own credentials from https://console.cloud.google.com/
    let GOOGLE_CLIENT_ID = '691968245686-5cdnqs5inasr62td91id893m70lg3k09.apps.googleusercontent.com';
    let GOOGLE_API_KEY = 'AIzaSyD3ZFca0_TgjnstevpbHfo1BNtEWtwlAO4';

    // Try to fetch from backend (for server deployments)
    fetch('/api/google/config')
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Backend not available (GitHub Pages detected)');
        }
      })
      .then(config => {
        if (config.client_id && config.api_key) {
          // Override with backend credentials (more secure)
          GOOGLE_CLIENT_ID = config.client_id;
          GOOGLE_API_KEY = config.api_key;
          console.log('âœ… Google Calendar credentials loaded from backend');
        }
      })
      .catch(error => {
        // Fallback to hardcoded credentials (GitHub Pages or backend offline)
        console.log('â„¹ï¸ Using fallback credentials (GitHub Pages mode)');
      });
  </script>

  <!-- Toast Notification Container -->
  <div id="toast-container"></div>

  <script src="{{ url_for('static', filename='calendar-connect.js') }}"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <script src="{{ url_for('static', filename='browse-events.js') }}" type="module"></script>

  <footer>
    Copyright Â© 2025 Project Helix
  </footer>
  </div>
</body>
</html>